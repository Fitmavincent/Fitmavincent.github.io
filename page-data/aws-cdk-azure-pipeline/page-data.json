{"componentChunkName":"component---src-templates-blog-post-js","path":"/aws-cdk-azure-pipeline/","result":{"data":{"site":{"siteMetadata":{"title":"Vince Blog"}},"markdownRemark":{"id":"a68cf423-31e7-52ed-b275-302edc2eabd5","excerpt":"Lesson learn with AWS CDK, Azure Pipeline Intro As per requested at work to build a modulised, scalable infrastructure, I’ve been messing around the AWS CDK. It…","html":"<h1>Lesson learn with AWS CDK, Azure Pipeline</h1>\n<h2>Intro</h2>\n<p>As per requested at work to build a modulised, scalable infrastructure, I’ve been messing around the AWS CDK. It’s quite a powerful tool to provision AWS infrastructure without touching the stupid <code class=\"language-text\">yml</code> file <strong><em>(Ya, it’s you <code class=\"language-text\">CloudFormation</code>)</em>.</strong> However the process hasn’t been smooth. Therefore, in this post, I just want to write down and summarise what I come across. <strong>This is not a tutorial</strong>. For that you got a great blog from <code class=\"language-text\">Carlos</code> <a href=\"https://www.mytechramblings.com/posts/provisioning-aws-resources-using-cdk-azure-devops/\">Provisioning resources on AWS using AWS CDK and Azure DevOps Pipelines</a>.</p>\n<hr>\n<h2>TL;DR</h2>\n<p>Simply put: </p>\n<blockquote>\n<p>This version of npm is compatible with lockfileVersion@1, but package-lock.json was generated for lockfileVersion@2.</p>\n</blockquote>\n<hr>\n<h2>The lesson</h2>\n<p>Let’s look at all the errors…</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4ab066c82ffb6f3fbd418d8b595902f6/20751/massive-failure.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 111.48648648648648%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACOUlEQVQ4y41UDZeiMAz0///Ju327KoV+QguoYDYTQCmwt8d7UazNdJLM9OS9p0IpKosv0pc/VFaatK44NIUQqOu6KfqeknPUxijvWOv521or+/Deti2d8OF9oOAMBaMo1A3VdeCoJWkcxymeT3qkSMPtJu/Lekop23dqeaHShmx1Ja8+yDoGZ9Zgjo14ngyAZ2QWz2HI1gB440OWtROSFoa1BcNa2DVNIyVgkwQnDJw83u/yvgBiD+IFiB8GfbAV1fosJQMMgb6sAYXh47EDxL4M0HKzvSnJV+eJbfDS6B3DNmeIWHq4YwjAwAydAL6HsmPIPfwnw77vpG9NsBRdQTG1fGp8NXsNiClvGeLQbCiRdaVUSZW6kLl+iA6NQRjCf8tGYYgDNgzRaxz+AgR6ExOl2lHyilLbcRlJSrmDzS9TRrkZQ6Br6FArsuXXNCDvRIc4PQPk5PFgyjh4M2UWMlxSfZIPkw6PhjLAESvAZcoZIJICQHgojSupnjWI/h3KZsMQ+RmglGwsOV2I9RyDQzaHOjwo+Ufrecu3i2Y/h7cOsRmG/0nYSw9zwNkptdPUmAuXHLncqeSt9YYD6+10iBMcbhf2slhvVfKOYdpb72DKiUVsRTau/JwmPl9fAPzNerspo6yGy8uEndKrN5n14rH1HtyGt/VYIkWhqCrOpK9/Z+sZCQwmY4jbesMQvc56eLsxQwwCDJ2aL4ckgZP/R4cZQyygb7hgcX0tTskuhjl54DaMq+QjYX8DmYuzxKEvroIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Massive Failure\"\n        title=\"Massive Failure\"\n        src=\"/static/4ab066c82ffb6f3fbd418d8b595902f6/fcda8/massive-failure.png\"\n        srcset=\"/static/4ab066c82ffb6f3fbd418d8b595902f6/12f09/massive-failure.png 148w,\n/static/4ab066c82ffb6f3fbd418d8b595902f6/e4a3f/massive-failure.png 295w,\n/static/4ab066c82ffb6f3fbd418d8b595902f6/fcda8/massive-failure.png 590w,\n/static/4ab066c82ffb6f3fbd418d8b595902f6/efc66/massive-failure.png 885w,\n/static/4ab066c82ffb6f3fbd418d8b595902f6/20751/massive-failure.png 1037w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>The error occured when the build is executing a <code class=\"language-text\">npm run build</code> after <code class=\"language-text\">npm install</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e74d0116244c8a12c7df70236008c517/6569d/dependency-error.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 92.56756756756756%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAA7DAAAOwwHHb6hkAAACSElEQVQ4y31UWbKjMAzkHhOyQYIBYyDskOXd/1IatUAMSV7Nh0q2bLe6JYFXpQk5ayljn7M30ZX2/o4Oe/+fHfbve7bjEgvOJypyR9am/M4nL7UxuTKjLLfi4ziSS2r6cOvVdH+5hBTi7vFAXl4wmEupaSoyDAaGJmJvIorNvL+EwRfYFhSK/N0fJpMwYMbMmG7fNtRUNyqZfuEyyp0lnNk0pjA4f5fhQz7OkyQlryhvVNwqSm1GScoALqc0c5RYRzHvw8hQEF7oxHLOp+Ob3xqAwyAgbxpHer2edJ8mlt1wcbkxxlAksg3LiGV9ZdlXrhXkR9eLrMFcYwLI3qtvJbV1JXIhu65KlpuJXJWMB2IMAA+gcFmDrUoXQDx2eMw+41oiOxqBhmCNB/8zyNXmCKDl+cMcATSJzduobDv72YTPOytgmsTCTD2YQQ4yYxR0JOB1rftfAcsiJ9g8KrN8gMOwRhLEoURjWh5Vo7ZnUG8aeno9HzSNAw1dS+PQsfXUcYPQJKzlrO84VktcY7eykC6DLQB3zNzDwQrYd+vlhjsvoJxEz7BGHPs7W9vU0mltjL/bkQeA5+MuQL0wnNnB8EDjsJpHC/uZbSNN1HlEDb8ARzBkAxBM2Sm4JFhUgCnGavuT8D8lz9lbqR0eYz0soNgD5D6NM2u+o0P+Bgj6j/u01kjrpAzxEMCQK7GlKZgME/3CEBl/5FueMwMcQFo/aQCfISESSYn4DjxGaTvoAoj6TEsjlAW+bTCYmVZrQ8rCrZ3Hve3IKOBfV6k4eGp9oucAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"fisrt error\"\n        title=\"fisrt error\"\n        src=\"/static/e74d0116244c8a12c7df70236008c517/fcda8/dependency-error.png\"\n        srcset=\"/static/e74d0116244c8a12c7df70236008c517/12f09/dependency-error.png 148w,\n/static/e74d0116244c8a12c7df70236008c517/e4a3f/dependency-error.png 295w,\n/static/e74d0116244c8a12c7df70236008c517/fcda8/dependency-error.png 590w,\n/static/e74d0116244c8a12c7df70236008c517/efc66/dependency-error.png 885w,\n/static/e74d0116244c8a12c7df70236008c517/c83ae/dependency-error.png 1180w,\n/static/e74d0116244c8a12c7df70236008c517/6569d/dependency-error.png 1328w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>The “Cannot find module” should’ve trigger some alarm bells in my head regarding the <code class=\"language-text\">npm install</code>. Yet I went a big route to debug, look for <code class=\"language-text\">node_modules</code>, whether that exists or not etc. </p>\n<p>And this line <code class=\"language-text\">This version of npm is compatible with lockfileVersion@1, but package-lock.json was generated for lockfileVersion@2. I&#39;ll try to do my best with it!</code> gives me a big impression that the <code class=\"language-text\">npm install</code> is totally fine. </p>\n<p>Plus, <code class=\"language-text\">AWS CDK</code> has been giving me problems. When they got a new release, I need to go the <code class=\"language-text\">package.json</code> to upgrade all my <code class=\"language-text\">cdk</code> modules, otherwise, builds fail, nothing works. </p>\n<p>After a while, I still could not have any clue of what is going on, I tried run this thing on my <code class=\"language-text\">WSL</code> since it’s running on the Linux box, as my friend suggested. But the result is everything fine. </p>\n<h3>So what went wrong…</h3>\n<p><br>\nFinally, I noticed one of my debug command regarding my NPM VERSION</p>\n<p>In my build script, I did put in a <code class=\"language-text\">NodeTool@0</code>, which is provided by Azure Pipeline. And I specify the verison to <code class=\"language-text\">16.x</code>. </p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\">  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">task</span><span class=\"token punctuation\">:</span> NodeTool@0\n    <span class=\"token key atrule\">inputs</span><span class=\"token punctuation\">:</span> \n      <span class=\"token key atrule\">versionSpec</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'16.x'</span>\n    <span class=\"token key atrule\">displayName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Install NodeJS\"</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a46ca1c0b6e23ed93427ea12aa1c2679/13e20/node-tools.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.72972972972974%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABqklEQVQoz32TaXLbMAyFdYx6kayFm0it1i7bcXv/Q70CcJKmM01/fANwewRAMCprh+beYug67NuC0lkk8RnpJfmWSxKjyDNUVcA0jRiuPbwvoVWByJYGpjGovEffNjIZn89y6H9k6QWOLh+Hqwg6a+WSSBeFLJraCLalhSJHnqUCb/oOFj4dfuB4OFAQJ8ks4oh86TAMvaTLNy7zRIy433Z0bS3rgVKqghf7MWarVQ6jFRQFwYigNRrTOFDYRg5d+058voA3M7yP576O+dzHmZevESlKmQ+y4Ol4pIga3PZN6rKti2wWcYqmdO7dWoHXpObxn5p/prxSikPfksiM5+Mm/Ho+Pu1X/+fbXfzx2kFxLeMTiZ3FRhw+P/m637E/npiXDVVLbVC3Qll3BPtUhlCLz7jQIEkzpIVGpgxybaCsfwlyKvO6YZoXepwR47ximGb4qoYtA5yvyHqhJFEXKsGHQOMKoaZ2sw45CYugNgWasUZL1ENFdaL24Yuods4oQsuYfe+MzAvkW6PEFtRiCbWO1JCLmWb0A9LkZWnMPfU38Tv/mn89Cv+i32TFQln5p68wAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"node-tools\"\n        title=\"node-tools\"\n        src=\"/static/a46ca1c0b6e23ed93427ea12aa1c2679/fcda8/node-tools.png\"\n        srcset=\"/static/a46ca1c0b6e23ed93427ea12aa1c2679/12f09/node-tools.png 148w,\n/static/a46ca1c0b6e23ed93427ea12aa1c2679/e4a3f/node-tools.png 295w,\n/static/a46ca1c0b6e23ed93427ea12aa1c2679/fcda8/node-tools.png 590w,\n/static/a46ca1c0b6e23ed93427ea12aa1c2679/13e20/node-tools.png 741w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Yet after I check my node version, it’s still at 14.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6bf4623c5dcae0d93b1a7b45f2df9d3b/13e20/node-version.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB0UlEQVQ4y41T2Y7bMAz0d3TjSz51WHZky0eyKLpo//+XpiQXObZoij4MSAnikBxSiT0cRj9gPk84TyMm8gPZtq6QpScUefZXNFWFYXASw7bvWqiyQKKjhncW80SE3iOMXnwOSE9vyLP0CzgJ20qVmIjs2Dcsc3gQllmG2tRoXIPGNlC9QmUqVLWSoFfgYK6UE3Bi9ssiR+K9w/X9gnkJ2PYVP3994MfHd8RllnYCSXHD8/nms1zWaOi+kyqTulKi32ANurbBHM6koxefwY9uAXw2uhfcCBieNOSKuVoh3NYItozr5cA0DkLM2fmuoQE94/mubWo5s67cdsKXa5wpaycTfifCY1vvdosLdkp4kBz7Fh+gu4WSMpzVD0LOEALpt+2IMcK5AW1LbVoL72mNaOLjOEIbQ7DQ2qDXWs5K0SbkOfKiJLJcSImwgT/PCNsF1k/orEdvB/QUbMYAO87Qw4SW78lny+jsiKa3aB2tmPEoyvKTkFuOtEf7ushwLAk+OCMSiE/D4iVPT9+QCd7uyNMnPLe8LousAe9Xnn4ucJFlL3/JK0iFPPbLdccSAy0zaaFylIqWtsjuWf+0/0LCVfEP4Z8iP8bWYlVdfiH4HzLGb1UUeut0+pNRAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"node-version\"\n        title=\"node-version\"\n        src=\"/static/6bf4623c5dcae0d93b1a7b45f2df9d3b/fcda8/node-version.png\"\n        srcset=\"/static/6bf4623c5dcae0d93b1a7b45f2df9d3b/12f09/node-version.png 148w,\n/static/6bf4623c5dcae0d93b1a7b45f2df9d3b/e4a3f/node-version.png 295w,\n/static/6bf4623c5dcae0d93b1a7b45f2df9d3b/fcda8/node-version.png 590w,\n/static/6bf4623c5dcae0d93b1a7b45f2df9d3b/13e20/node-version.png 741w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>I started getting frustrated, until I found this: <a href=\"https://github.com/actions/virtual-environments/blob/main/images/linux/Ubuntu2004-README.md\">Ubuntu2004-README.md</a> from <a href=\"https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/hosted?view=azure-devops&#x26;tabs=yaml\">MS Hosted agent</a>. </p>\n<p>The <code class=\"language-text\">ubuntu-latest</code> image that I’m using got pre-installed <code class=\"language-text\">NodeJS 14.x</code>. And the <code class=\"language-text\">NodeTool@0</code> does not change anything for the build agent. </p>\n<p>And this <a href=\"https://github.com/aws/aws-cdk/issues/13541\">aws-cdk issue</a> confirms my error was on the difference of my <code class=\"language-text\">npm</code> version on build agent and my local npm version that generated my <code class=\"language-text\">package-lock.json</code>.</p>\n<p>Shamail (from the above github issue) has a good enough explanation of what happend: </p>\n<blockquote>\n<p>“My issue was due to the default codebuild image using npm v6.x instead of npm v7.x, which i’m using locally and which produces a lockfileVersion:2 instead of lockfileVersion:1 package-lock.json file. So when codebuild pulls the code from my repo, it’s getting a package-lock.json that isn’t compatible with npm v6.x but it tries to use it anyway without throwing a mismatch error.”</p>\n</blockquote>\n<p><br>\nOnce I done a force delete of my <code class=\"language-text\">package-lock.json</code>, my problem resovled. </p>","frontmatter":{"title":"AWS CDK Azure Pipeline","date":"May 11, 2021","description":"AWS CDK deploy pipeline with Azure DevOps"}}},"pageContext":{"slug":"/aws-cdk-azure-pipeline/","previous":{"fields":{"slug":"/hello-world/"},"frontmatter":{"title":"Hello World"}},"next":null}},"staticQueryHashes":["148235104","240262808","2841359383"]}